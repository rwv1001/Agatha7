<% Rails.logger.info("update_helper .js.erb #{@table_name}, #{attribute.name}, #{id}"); %>
<% Rails.logger.info("update_helper .js.erb edit_cell.attribute.name =  #{edit_cell1.attribute.name}"); %>

opener_window = window.opener;
doc = opener_window.document;

<% attribute_names = [attribute.name] %>
<% edited_table_name = @table_name %>
<% ids = [id] %>
<% Rails.logger.info("update_main_remote.js.erb a"); %>

<% search_ctls.each do |table_name, search_ctl| %>
  <% table_name.set_controller(search_ctl) %>
  <% updated_objects = search_ctl.GetUpdateObjects(edited_table_name, attribute_names, ids) %>

  <% updated_objects.each do |row| %>
    (function(){
      const elId = "<%= "#{row.id}_#{table_name}" %>";
      const el   = doc.getElementById(elId);
      if (el) {
        el.outerHTML = "<%= j render(partial: 'shared/search_results_row_button', object: row) %>";
        opener_window.setcheck("<%= "#{table_name}_check_#{row.id}" %>", true);
      }
      const newOptionText = "<%= search_ctl.GetShortField(row.id) %>";
      opener_window.select_update("<%= table_name %>", <%= row.id %>, newOptionText);
    })();
  <% end %>

  <% if table_name == edited_table_name %>
    <% results_table_name  = "search_results_table_#{table_name}" %>
    <% current_filter_name = "current_filters_#{table_name}" %>

    // hide current filters
    (function(){
      const filtEl = doc.getElementById("<%= current_filter_name %>");
      if (filtEl) filtEl.style.display = "none";
    })();

    <% select_string = search_ctl.get_sql_id_string(ids) %>
    <% table_name.set_controller(search_ctl) %>
    <% new_rows = eval("#{table_name}.find_by_sql(\"#{select_string}\")") %>

    <% new_rows.each do |new_row| %>
      (function(){
        const rowId   = "<%= "#{new_row.id}_#{table_name}" %>";
        const rowEl   = doc.getElementById(rowId);
        const tableEl = doc.getElementById("<%= results_table_name %>");
        const htmlStr = "<%= j render(partial: 'shared/search_results_row_button', object: new_row) %>";

        if (rowEl) {
          rowEl.outerHTML = htmlStr;

        } else if (tableEl) {
          const lastTr = tableEl.querySelector("tr:last-child");
          if (lastTr) lastTr.insertAdjacentHTML("afterend", htmlStr);

        } else {
          const container = doc.getElementById("search_results_<%= table_name %>");
          if (container) {
            container.innerHTML = "<%= j render(partial: 'shared/search_results', object: SearchResults.new([new_row], :search_results, search_ctl)) %>";
            opener_window.resizeX();
          }
        }

        const optText = "<%= search_ctl.GetShortField(new_row.id) %>";
        opener_window.select_update("<%= table_name %>", <%= new_row.id %>, optText);
      })();
    <% end %>
  <% end %>

  // recolour the updated table
  opener_window.recolour("<%= table_name %>");
<% end %>

opener_window.action_select_no_js();

<% if edit_cell1.attribute %>
(function(){
  const id1 = "<%= "#{@table_name}_#{field_name}" %>";
  const el1 = document.getElementById(id1);
  if (el1) {
    el1.outerHTML = "<%= j render(partial: 'shared/edit_cell', object: edit_cell1) %>";
  }
})();
<% end %>

<% if edit_cell2.attribute %>
(function(){
  const id2 = "<%= "#{@table_name}_updated_at" %>";
  const el2 = document.getElementById(id2);
  if (el2) {
    el2.outerHTML = "<%= j render(partial: 'shared/edit_cell', object: edit_cell2) %>";
  }
})();
<% end %>
