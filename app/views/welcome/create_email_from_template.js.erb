unwait();

<% if error_str.length > 0 %>
  if (window.showNotification) {
    window.showNotification('<%= j error_str %>', 'error');
  } else {
    alert('<%= j error_str %>');
  }
<% else %>
  <% results_table_name  = "search_results_table_AgathaEmail" %>
  <% current_filter_name = "current_filters_AgathaEmail" %>

  <% AgathaEmail.set_controller(search_ctl) %>
  <% eval_str = "AgathaEmail.find_by_sql(\"SELECT * FROM agatha_emails WHERE id IN (#{id_str})\")" %>
  <% Rails.logger.info("create_email_from_template eval_str = #{eval_str}") %>
  <% new_emails      = eval(eval_str) %>
  <% search_results  = SearchResults.new(new_emails, :search_results, search_ctl) %>
  <% search_results.table_type = :search_results %>

  // hide the ‚Äúcurrent filters‚Äù container
  document.getElementById('<%= current_filter_name %>').style.display = 'none';

  // if the results table already exists, append each new row
  if (document.getElementById('<%= results_table_name %>')) {
    <% new_emails.each do |new_row| %>
      (function(){
        const lastTr = document.querySelector('#<%= results_table_name %> tr:last-child');
        if (lastTr) {
          lastTr.insertAdjacentHTML(
            'afterend',
            '<%= j render(partial: "shared/search_results_row_button", object: new_row) %>'
          );
          
          // Apply proper cell display based on current display settings
          setTimeout(() => {
            const newRowElement = document.getElementById('<%= new_row.id %>_AgathaEmail');
            if (newRowElement && typeof window.hideCellsBasedOnCurrentDisplay === 'function') {
              console.log('üîß Applying hideCellsBasedOnCurrentDisplay to newly created email row');
              window.hideCellsBasedOnCurrentDisplay(newRowElement, 'AgathaEmail');
            }
          }, 10);
        }
      })();
    <% end %>
  } else {
    // otherwise render the entire results block
    document.getElementById('search_results_AgathaEmail').innerHTML =
      '<%= j render(partial: "shared/search_results", object: search_results) %>';
    resizeX();
  }

  action_select_no_js();
  recolour('AgathaEmail');

  if (window.showNotification) {
    window.showNotification('<%= j success_str + warning_str %>', 'success');
  } else {
    alert('<%= j success_str + warning_str %>');
  }
<% end %>
